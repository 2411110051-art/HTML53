<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgroIA ‚Äî Opci√≥n 3 (Firebase & PWA)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}</style>
  <!-- PWA manifest placeholder (create public/manifest.json and link here in production) -->
  <!-- <link rel="manifest" href="/manifest.json"> -->
</head>
<body class="bg-emerald-50 text-emerald-900 min-h-screen">
  <div class="max-w-5xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-lg bg-emerald-700 text-white flex items-center justify-center">üîê</div>
        <div>
          <h1 class="text-xl font-bold">AgroIA ‚Äî Firebase + PWA (prototipo)</h1>
          <div class="text-sm text-slate-600">Autenticaci√≥n y persistencia (Firestore) ‚Äî rellena firebaseConfig</div>
        </div>
      </div>
      <div>
        <button id="btnSignOut" class="px-3 py-2 rounded bg-white shadow hidden">Cerrar sesi√≥n</button>
      </div>
    </header>

    <!-- Auth -->
    <section class="bg-white p-4 rounded shadow mb-4">
      <h2 class="font-bold">Registro / Inicio de sesi√≥n</h2>
      <div id="authArea" class="mt-3">
        <input id="email" placeholder="Correo" class="p-2 border rounded w-full mt-2" />
        <input id="password" placeholder="Contrase√±a" type="password" class="p-2 border rounded w-full mt-2" />
        <div class="mt-2 flex gap-2">
          <button id="btnSignUp" class="px-3 py-2 bg-emerald-700 text-white rounded">Crear cuenta</button>
          <button id="btnSignIn" class="px-3 py-2 border rounded">Iniciar sesi√≥n</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">Tambi√©n puedes implementar login por tel√©fono (OTP) ‚Äî requiere reCAPTCHA y habilitaci√≥n en Firebase Console.</p>
      </div>
    </section>

    <main class="grid md:grid-cols-2 gap-6">

      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold">Contenido principal (diagn√≥stico / cat√°logo)</h3>
        <p class="text-sm text-slate-600">Mismo prototipo: c√°mara y asistente. Al estar logueado, los recordatorios y compras se guardan en Firestore.</p>

        <div class="mt-3">
          <button id="startCam" class="px-3 py-2 rounded bg-emerald-700 text-white">Iniciar c√°mara</button>
          <button id="stopCam" class="px-3 py-2 rounded border">Detener</button>
          <video id="video" class="w-full max-h-64 object-cover mt-3" autoplay playsinline muted style="display:none"></video>
          <div id="diagnosis" class="mt-3 text-sm text-slate-600">Resultado: ‚Äî</div>
        </div>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold">Planificador & Notificaciones</h3>
        <p class="text-sm text-slate-600">Si est√°s autenticado, se guardan planes en Firestore y puedes programar notificaciones push (FCM).</p>

        <div class="mt-3">
          <label class="text-sm">Cultivo</label>
          <select id="crop" class="w-full p-2 border rounded mt-1">
            <option>Uva</option><option>Tomate</option><option>Palta</option>
          </select>
          <label class="text-sm mt-2">Fecha inicio</label>
          <input id="start" type="date" class="w-full p-2 border rounded mt-1" />
          <button id="savePlan" class="mt-3 px-3 py-2 bg-emerald-700 text-white rounded">Guardar plan</button>
        </div>
      </div>

    </main>

    <footer class="mt-6 text-sm text-emerald-600">Recuerda: rellena firebaseConfig en el c√≥digo y habilita Auth + Firestore en tu proyecto Firebase.</footer>
  </div>

  <!-- Firebase SDKs (cdn) -->
  <script src="https://www.gstatic.com/firebasejs/10.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.21.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.21.0/firebase-firestore-compat.js"></script>
  <script>
    /*******************************************************************
     * AGROIA - Opci√≥n 3 (Firebase + PWA placeholders)
     *
     * 1) RELLENA firebaseConfig con la configuraci√≥n de tu proyecto.
     * 2) En Firebase Console activa Authentication (email/password) y Firestore.
     * 3) Para Phone OTP se necesita reCAPTCHA (no incluido aqu√≠).
     *
     * EJEMPLO:
     * const firebaseConfig = {
     *   apiKey: "AIza....",
     *   authDomain: "mi-proy.firebaseapp.com",
     *   projectId: "mi-proy",
     *   storageBucket: "mi-proy.appspot.com",
     *   messagingSenderId: "123456789",
     *   appId: "1:123:web:abc",
     *   measurementId: "G-XYZ"
     * };
     *******************************************************************/

    // --------- PON TU CONFIG AQUI ----------
    const firebaseConfig = {
      apiKey: "REEMPLAZA_APIKEY",
      authDomain: "REEMPLAZA_FIREBASEAPP",
      projectId: "REEMPLAZA_PROJECTID",
      storageBucket: "REEMPLAZA.appspot.com",
      messagingSenderId: "REEMPLAZA",
      appId: "REEMPLAZA_WEB_APPID"
    };
    // ---------------------------------------

    // Initialize Firebase
    try {
      firebase.initializeApp(firebaseConfig);
    } catch(e){
      console.warn('Firebase init failed. Revisa firebaseConfig.', e);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    // UI elements
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const btnSignUp = document.getElementById('btnSignUp');
    const btnSignIn = document.getElementById('btnSignIn');
    const btnSignOut = document.getElementById('btnSignOut');
    const authArea = document.getElementById('authArea');

    const startCam = document.getElementById('startCam');
    const stopCam = document.getElementById('stopCam');
    const video = document.getElementById('video');
    const diagnosis = document.getElementById('diagnosis');

    const crop = document.getElementById('crop');
    const start = document.getElementById('start');
    const savePlan = document.getElementById('savePlan');

    let stream = null;

    // Auth flows (email/password)
    btnSignUp.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const pass = passEl.value.trim();
      if(!email || !pass) return alert('Completa email y contrase√±a');
      try {
        const userCred = await auth.createUserWithEmailAndPassword(email, pass);
        alert('Cuenta creada: ' + userCred.user.email);
      } catch(err){ alert('Error: ' + err.message); }
    });

    btnSignIn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const pass = passEl.value.trim();
      if(!email || !pass) return alert('Completa email y contrase√±a');
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        alert('Sesi√≥n iniciada');
      } catch(err){ alert('Error: ' + err.message); }
    });

    btnSignOut.addEventListener('click', async () => {
      await auth.signOut();
      alert('Sesi√≥n cerrada');
    });

    // Observe auth state
    auth.onAuthStateChanged(user => {
      if(user){
        btnSignOut.classList.remove('hidden');
        authArea.innerHTML = `<div>Conectado como <strong>${user.email}</strong></div>`;
      } else {
        btnSignOut.classList.add('hidden');
        authArea.style.display='block';
      }
    });

    // Camera simple
    startCam.addEventListener('click', async ()=>{
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return alert('C√°mara no disponible');
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject = stream; video.style.display='';
      // In this demo we just show frame time to time
      setInterval(()=>{ diagnosis.textContent = 'Analizando (simulado): sano / revisar 3 d√≠as'; }, 4000);
    });
    stopCam.addEventListener('click', ()=>{
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; video.style.display='none'; }
    });

    // Save plan to Firestore (if logged)
    savePlan.addEventListener('click', async ()=>{
      const user = auth.currentUser;
      if(!user) return alert('Inicia sesi√≥n para guardar el plan');
      const payload = { uid: user.uid, crop: crop.value, start: start.value, createdAt: new Date() };
      try{
        await db.collection('plans').add(payload);
        alert('Plan guardado en Firestore');
      }catch(e){ alert('Error guardando plan: '+e.message); }
    });

    // PWA placeholders: sample manifest.json and service worker file (create them in /public)
    /* manifest.json example:
    {
      "name":"AgroIA",
      "short_name":"AgroIA",
      "start_url":"/",
      "display":"standalone",
      "background_color":"#ffffff",
      "theme_color":"#0f766e",
      "icons":[ { "src": "/icons/icon-192.png", "sizes":"192x192", "type":"image/png" } ]
    }
    */
    /* service-worker.js simple placeholder:
    self.addEventListener('install', event => { self.skipWaiting(); });
    self.addEventListener('activate', event => { clients.claim(); });
    self.addEventListener('fetch', event => { /* basic network-first strategy *\/ });
    */

    // Notes for phone auth:
    // To enable phone (OTP) you must:
    // 1) Enable Phone provider in Firebase Console
    // 2) Add reCAPTCHA verifier and use signInWithPhoneNumber(phone, recaptchaVerifier)
    // This demo keeps only email/password for simplicity.

  </script>
</body>
</html>
